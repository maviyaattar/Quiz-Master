<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Test | QuizMaster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Icons -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --primary:#5b6cff;
      --secondary:#8f5bff;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --radius:18px;
      --success:#22c55e;
      --danger:#ef4444;
    }

    *{
      margin:0;
      padding:0;
      box-sizing:border-box;
      font-family:"Poppins",sans-serif;
    }

    body{
      background:linear-gradient(180deg,#f5f7fb,#eef0ff);
      min-height:100vh;
      color:var(--text);
    }

    /* ===== TOP BAR ===== */
    .top-bar{
      display:flex;
      align-items:center;
      gap:14px;
      padding:16px 22px;
      background:#fff;
      box-shadow:0 8px 20px rgba(0,0,0,.08);
    }

    .back-btn{
      font-size:20px;
      color:var(--primary);
      cursor:pointer;
    }

    .top-bar h2{
      font-size:18px;
      font-weight:600;
    }

    /* ===== CONTAINER ===== */
    .container{
      max-width:900px;
      margin:auto;
      padding:26px;
    }

    /* ===== CARD ===== */
    .card{
      background:#fff;
      padding:24px;
      border-radius:var(--radius);
      box-shadow:0 18px 35px rgba(0,0,0,.12);
      margin-bottom:24px;
    }

    .card h3{
      margin-bottom:14px;
    }

    /* ===== INPUTS ===== */
    .input{
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      margin-bottom:14px;
      font-size:14px;
    }

    textarea.input{
      min-height:90px;
      resize:vertical;
    }

    /* ===== OPTIONS ===== */
    .option{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }

    .option input[type="radio"]{
      transform:scale(1.2);
      cursor:pointer;
    }

    /* ===== BUTTONS ===== */
    .btn{
      padding:12px 24px;
      border-radius:30px;
      border:none;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      transition:.25s;
    }

    .btn-primary{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;
    }

    .btn-secondary{
      background:#eef0ff;
      color:var(--primary);
    }

    .btn-danger{
      background:var(--danger);
      color:#fff;
    }

    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(91, 108, 255, 0.3);
    }

    .btn:active{
      transform:translateY(0);
    }

    /* ===== QUESTION LIST ===== */
    .question-item{
      background:#f9faff;
      padding:16px;
      border-radius:14px;
      margin-bottom:12px;
      box-shadow:0 8px 18px rgba(0,0,0,.08);
      animation:slideIn 0.3s ease-out;
      transition:transform 0.2s ease;
    }

    .question-item:hover{
      transform:translateX(4px);
    }

    @keyframes slideIn{
      from{opacity:0;transform:translateX(-20px);}
      to{opacity:1;transform:translateX(0);}
    }

    .question-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }

    .question-actions i{
      margin-left:12px;
      cursor:pointer;
      color:var(--muted);
      transition:all 0.2s ease;
    }

    .question-actions i:hover{
      color:var(--primary);
      transform:scale(1.2);
    }

    .question-actions .fa-trash:hover{
      color:var(--danger);
    }

    .correct{
      color:var(--success);
      font-weight:600;
      font-size:13px;
    }

    .footer-action{
      text-align:center;
      margin-top:30px;
    }

    @media(max-width:768px){
      .container{padding:18px}
      .btn{width:100%}
    }
  </style>
</head>

<body>

<!-- ===== TOP BAR ===== -->
<div class="top-bar">
  <i class="fa fa-arrow-left back-btn" onclick="goBack()"></i>
  <h2>Create New Test</h2>
</div>

<div class="container">

  <!-- TEST INFO -->
  <div class="card">
    <h3>Test Information</h3>
    <input class="input" id="testTitle" placeholder="Test Title">
    <textarea class="input" id="testDesc" placeholder="Test Description"></textarea>
    <input class="input" id="testDuration" type="number" placeholder="Duration (minutes)">
  </div>

  <!-- QUESTION BUILDER -->
  <div class="card">
    <h3>Add / Edit Question</h3>

    <textarea class="input" id="questionText" placeholder="Question"></textarea>

    <div class="option">
      <input type="radio" name="correct" value="0">
      <input class="input" id="opt0" placeholder="Option A">
    </div>
    <div class="option">
      <input type="radio" name="correct" value="1">
      <input class="input" id="opt1" placeholder="Option B">
    </div>
    <div class="option">
      <input type="radio" name="correct" value="2">
      <input class="input" id="opt2" placeholder="Option C">
    </div>
    <div class="option">
      <input type="radio" name="correct" value="3">
      <input class="input" id="opt3" placeholder="Option D">
    </div>

    <button class="btn btn-secondary" id="saveBtn" onclick="saveQuestion()">
      <i class="fa fa-save"></i> Save Question
    </button>
    <button class="btn btn-danger" id="cancelBtn" onclick="cancelEdit()" style="display:none;margin-left:10px;">
      <i class="fa fa-times"></i> Cancel Edit
    </button>
  </div>

  <!-- QUESTIONS LIST -->
  <div class="card">
    <h3>Questions Added</h3>
    <div id="questionList" style="color:var(--muted)">
      No questions added yet
    </div>
  </div>

  <!-- CREATE -->
  <div class="footer-action">
    <button class="btn btn-primary" onclick="createTest()">
      <i class="fa fa-check"></i> Create Test
    </button>
  </div>

</div>

<script>
/* =====================
   CONFIG
===================== */
const API_BASE = "https://quiz-backend-production-4aaf.up.railway.app";
const token = localStorage.getItem("token");

if(!token){
  location.href = "Auth.html";
}

/* =====================
   STATE
===================== */
let questions = [];
let editIndex = null;

/* =====================
   NAV
===================== */
function goBack(){
  location.href = "dashboard.html";
}

/* =====================
   SAVE QUESTION
===================== */
function saveQuestion(){
  const text = questionText.value.trim();
  const options = [
    opt0.value.trim(),
    opt1.value.trim(),
    opt2.value.trim(),
    opt3.value.trim()
  ];
  const correct = document.querySelector("input[name='correct']:checked");

  if(!text || options.some(o=>!o) || !correct){
    alert("Fill all fields and select correct option");
    return;
  }

  const q = {
    text,
    options,
    correctIndex: Number(correct.value)
  };

  if(editIndex !== null){
    questions[editIndex] = q;
    editIndex = null;
  } else {
    questions.push(q);
  }

  clearForm();
  renderQuestions();
}

/* =====================
   RENDER QUESTIONS
===================== */
function renderQuestions(){
  const list = document.getElementById("questionList");
  list.innerHTML = "";

  if(questions.length === 0){
    list.innerHTML = "No questions added yet";
    // Update heading
    document.querySelector(".card:nth-child(3) h3").innerText = "Questions Added";
    return;
  }

  // Update heading with count
  document.querySelector(".card:nth-child(3) h3").innerText = `Questions Added (${questions.length})`;

  questions.forEach((q,i)=>{
    const div = document.createElement("div");
    div.className = "question-item";

    div.innerHTML = `
      <div class="question-header">
        <strong>Q${i+1}. ${q.text}</strong>
        <div class="question-actions">
          <i class="fa fa-pen" onclick="editQuestion(${i})" title="Edit question"></i>
          <i class="fa fa-trash" onclick="deleteQuestion(${i})" title="Delete question"></i>
        </div>
      </div>
      <div class="correct">
        Correct Option: ${String.fromCharCode(65 + q.correctIndex)}
      </div>
    `;

    list.appendChild(div);
  });
}

/* =====================
   BUTTON STATE MANAGEMENT
===================== */
function setButtonStateEdit(){
  document.getElementById("saveBtn").innerHTML = '<i class="fa fa-save"></i> Update Question';
  document.getElementById("cancelBtn").style.display = 'inline-block';
}

function setButtonStateNormal(){
  document.getElementById("saveBtn").innerHTML = '<i class="fa fa-save"></i> Save Question';
  document.getElementById("cancelBtn").style.display = 'none';
}

/* =====================
   EDIT / DELETE
===================== */
function editQuestion(i){
  const q = questions[i];
  questionText.value = q.text;
  [opt0.value,opt1.value,opt2.value,opt3.value] = q.options;
  document.querySelector(
    `input[name='correct'][value='${q.correctIndex}']`
  ).checked = true;
  editIndex = i;
  
  // Update button state
  setButtonStateEdit();
  
  // Scroll to form
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function deleteQuestion(i){
  if(confirm("Delete this question?")){
    questions.splice(i,1);
    renderQuestions();
  }
}

function cancelEdit(){
  editIndex = null;
  clearForm();
}

/* =====================
   CLEAR FORM
===================== */
function clearForm(){
  questionText.value = "";
  [opt0,opt1,opt2,opt3].forEach(o=>o.value="");
  document.querySelectorAll("input[name='correct']")
    .forEach(r=>r.checked=false);
  setButtonStateNormal();
}

/* =====================
   CREATE TEST (REAL API)
===================== */
async function createTest(){
  const title = testTitle.value.trim();
  const description = testDesc.value.trim();
  const durationMin = Number(testDuration.value);

  if(!title || !description || !durationMin){
    alert("Fill all test details");
    return;
  }

  if(questions.length === 0){
    alert("Add at least one question");
    return;
  }

  const payload = {
    title,
    description,
    duration: durationMin * 60, // minutes â†’ seconds
    questions
  };

  // Show loading state
  const createBtn = event.target;
  const originalText = createBtn.innerHTML;
  createBtn.disabled = true;
  createBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Creating...';

  try{
    const res = await fetch(`${API_BASE}/api/quiz/create`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + token
      },
      body:JSON.stringify(payload)
    });

    const data = await res.json();

    if(!res.ok){
      alert(data.msg || "Failed to create test");
      createBtn.disabled = false;
      createBtn.innerHTML = originalText;
      return;
    }

    alert("ðŸŽ‰ Test created successfully!");
    location.href = "dashboard.html";

  }catch(err){
    alert("Server error. Try again.");
    console.error(err);
    createBtn.disabled = false;
    createBtn.innerHTML = originalText;
  }
}
</script>

</body>
</html>
